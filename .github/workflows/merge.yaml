name: Merge to Main

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  terraform-checks:
    name: Terraform Validate & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"
          terraform_wrapper: false

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive -write=false

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

      - name: Install TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: "v0.53.0"

      - name: TFLint init
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          soft_fail: false
          framework: terraform

  docker-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile

  docker-build-and-scan:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t app:${{ github.sha }} ./app

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: app:${{ github.sha }}
          format: table
          exit-code: 1
          severity: HIGH,CRITICAL

  app-security:
    name: Application Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy FS scan (app/)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: ./app
          severity: HIGH,CRITICAL
          exit-code: 1
          format: table

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (Secret Scan)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --redact --verbose

  docker-compose-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start Docker Compose services
        run: docker compose up -d --build

      - name: Wait for app to be ready
        run: |
          echo "Waiting for app to become ready..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/api/db-check > /dev/null; then
              echo "App is ready!"
              exit 0
            fi
            echo "Still waiting..."
            sleep 5
          done
          echo "App did not become ready in time"
          exit 1

      - name: Verify DB check endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/db-check)
          if [ "$response" != "200" ]; then
            echo "Endpoint failed with status $response"
            exit 1
          fi
          echo "DB check endpoint returned 200 OK"

      - name: Tear down services
        if: always()
        run: docker compose down -v

  build-and-push:
    name: Build & Push to GHCR
    runs-on: ubuntu-latest
    needs:
      - terraform-checks
      - docker-lint
      - docker-build-and-scan
      - app-security
      - secret-detection
      - docker-compose-test
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and tag Docker image
        run: |
          IMAGE="ghcr.io/${{ github.repository }}"
          docker build -t "${IMAGE}:${{ github.sha }}" -t "${IMAGE}:latest" ./app

      - name: Push Docker image
        run: |
          IMAGE="ghcr.io/${{ github.repository }}"
          docker push "${IMAGE}:${{ github.sha }}"
          docker push "${IMAGE}:latest"
